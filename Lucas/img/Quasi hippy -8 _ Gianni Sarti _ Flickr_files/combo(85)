YUI.add("hermes-template-sub-photo-tags-people-section",function(e,a){var n=e.Template.Handlebars.revive({1:function(e,a,n,t,s){var r=null!=a?a:{},l=n.helperMissing,i=e.escapeExpression;return'    <a href="#" class="show-add-people">'+i((n.intlMessage||a&&a.intlMessage||l).call(r,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_PEOPLE"},data:s}))+'</a>\n\t<input type ="text" class="add-person" placeholder="'+i((n.intlMessage||a&&a.intlMessage||l).call(r,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_PERSON"},data:s}))+'">\n'},3:function(e,a,n,t,s){var r;return null!=(r=n.if.call(null!=a?a:{},null!=a?a.person:a,{name:"if",hash:{},fn:e.program(4,s,0),inverse:e.program(6,s,0),data:s}))?r:""},4:function(e,a,n,t,s){var r;return null!=(r=e.invokePartial(t["sub-photo-person"],null!=a?a.person:a,{name:"sub-photo-person",data:s,indent:"\t\t\t",helpers:n,partials:t,decorators:e.decorators}))?r:""},6:function(e,a,n,t,s){var r;return null!=(r=e.invokePartial(t["invite-person"],null!=a?a.invite:a,{name:"invite-person",data:s,indent:"\t\t\t",helpers:n,partials:t,decorators:e.decorators}))?r:""},compiler:[7,">= 4.0.0"],main:function(e,a,n,t,s){var r,l=null!=a?a:{};return'<h3 tabindex="0">'+e.escapeExpression((n.intlMessage||a&&a.intlMessage||n.helperMissing).call(l,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.PEOPLE_IN_PHOTO"},data:s}))+"</h3>\n\n"+(null!=(r=n.if.call(l,null!=a?a.canAddMeta:a,{name:"if",hash:{},fn:e.program(1,s,0),inverse:e.noop,data:s}))?r:"")+'\n<div class="person-list">\n'+(null!=(r=n.each.call(l,null!=a?a.people:a,{name:"each",hash:{},fn:e.program(3,s,0),inverse:e.noop,data:s}))?r:"")+'</div>\n\n<div style="clear:both;"></div>\n'},usePartial:!0,useData:!0}),t={};e.Array.each(["sub-photo-person","invite-person"],function(a){var n=e.Template.get("hermes/"+a);n&&(t[a]=n)}),e.Template.register("hermes/sub-photo-tags-people-section",function(a,s){return s=s||{},s.partials=s.partials?e.merge(t,s.partials):t,n(a,s)})},"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-sub-photo-person","hermes-template-invite-person"]});YUI.add("sub-photo-tags-people-view",function(e,t){var o=require("hermes-core/flog")(t);e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this._css={locked:"ui-util-locked",working:"ui-util-working",removed:"ui-util-removed",shim:"c-contact-search-shim"},this},loadState:function(){var t=this;return new e.FlickrPromise({photo:this.appContext.getModel("photo-models",this.photoId),photoPeople:this.appContext.getModel("photo-people-models",this.photoId),peopleModel:this.appContext.getModelRegistry("person-in-photo-models"),person:this.appContext.getModelRegistry("person-models")}).then(function(e){t.set("photo",e.photo),t.set("photoPeople",e.photoPeople),t.set("peopleModel",e.peopleModel),t.set("person",e.person)}).then(function(){var e=t.appContext.getViewer();if(e.signedIn)return t.get("person").get(e.nsid).then(function(e){t.set("me",e)})})},buildContainer:function(){var e,t=this.get("photo"),o=this.get("photoPeople").getValue("people"),n=t.getValue("isOwner")||t.getValue("canAddMeta"),a=t.getValue("isOwner"),s=this,i=!1;return o&&(0===(e=o.toJSON()).length&&n&&(i=!0,this.get("container").addClass("empty"),this.fire("subviewViewEvent","tagsPeopleView:peopleEmpty")),e.forEach(function(e){e.person?(e.person.size=32,e.person.showRemove=s.canRemoveTag(a,s.appContext.getViewer().nsid,e.addedBy,e.person.nsid),e.person.dataAttr={key:"person-nsid",value:e.person.nsid}):(e.invite={size:32,email:e.email},e.invite.showRemove=s.canRemoveTag(a,s.appContext.getViewer().nsid,e.addedBy,null),e.invite.dataAttr={key:"person-tag-email",value:e.invite.email})}),e=e.sort(function(e,t){return e.invite&&t.person?-1:e.person&&t.invite?1:e.person&&t.person&&e.person.displayname.toUpperCase()<t.person.displayname.toUpperCase()?-1:e.person&&t.person&&e.person.displayname.toUpperCase()>t.person.displayname.toUpperCase()?1:e.invite&&t.invite&&e.invite.email&&t.invite.email&&e.invite.email.toUpperCase()<t.invite.email.toUpperCase()?-1:e.invite&&t.invite&&e.invite.email&&t.invite.email&&e.invite.email.toUpperCase()>t.invite.email.toUpperCase()?1:0})),n||e.length>0?this.setContainerWithTemplate("sub-photo-tags-people-section",{people:e,canAddMeta:n,emptyPeopleTags:i}):this.setContainerHTML(""),this},focusTag:function(){var e=this.get("container").one(".add-person");e&&e.focus()},activate:function(){var t=this.get("container"),o=t.one(".add-person"),n=this.get("photoPeople")?this.get("photoPeople").getValue("people"):null,a=[],s=this;return t.one(".show-add-people")&&(this.registerEventHandler(t.one(".show-add-people").on("click",function(e){e.preventDefault(),t.hasClass("empty")&&(t.removeClass("empty"),s.fire("subviewViewEvent","tagsPeopleView:peopleNotEmpty")),t.one(".c-contact-search-autocomplete").setStyle("display","block"),t.one(".add-person").setStyle("display","block"),t.one(".add-person").focus()})),this.attachKeyEvent("down:80",function(o){o.preventDefault();var n=t.one(".add-person");try{t.hasClass("empty")&&(t.removeClass("empty"),s.fire("subviewViewEvent","tagsPeopleView:peopleNotEmpty")),t.one(".c-contact-search-autocomplete").setStyle("display","block"),n.setStyle("display","block"),n.focus(),e.AnchorRepositioner.jumpTo(t)}catch(e){}})),this.focus&&(setTimeout(function(){o.focus()},100),this.focus=!1),o&&(n&&(a=n.getList()),this.arrow=e.Node.create('<span class="ui-dialog-arrow contact-autocomplete-arrow"></span>'),this.contacts=new e.ContactSearchBox({el:o,appContext:this.appContext,shim:this._css.shim,elValue:"value",signedOut:!1,canTag:1,noShim:!0,searchNonContacts:!0,loadMoreOnScroll:!0,upInitially:!1,alwaysDownward:!0,loadingState:this.templates(e.Balls())(),max:1e3,hideInitially:a.map(function(e){return e.id}),me:this.get("me"),onError:function(){o.blur(),s.contacts.hide(),s.fire("subviewViewEvent","getDialogOffset",function(t){new e.Views.FluidModal({appContext:s.appContext,title:s.intlMessage({intlName:"common.ERROR"}),message:s.intlMessage({intlName:"photo-page-scrappy.CONTACT_LIST_ERROR"}),actionButtonLabel:s.intlMessage({intlName:"common.OK"}),showCancelButton:!1,classList:"scrappy-dialog"}).show()})},onShow:function(n){var a=o.ancestor(".c-contact-search-autocomplete");s.arrow||(s.arrow=e.Node.create('<span class="ui-dialog-arrow contact-autocomplete-arrow"></span>')),s.arrow.inDoc()||a.appendChild(s.arrow),s.arrow.removeClass("hide"),t.addClass(s._css.locked),s.fire("subviewViewEvent","make in view",t)},onSelect:function(e){e?t.removeClass(s._css.locked):t.addClass(s._css.locked)},onHide:function(){var e=o;s.arrow.addClass("hide"),e.setHTML(""),s.fire("subviewViewEvent","close in view")},onOrientationChange:function(e){s.arrow&&(e?s.arrow.addClass("upside-down"):s.arrow.removeClass("upside-down"))},clickContact:function(t,n){var a,i,r,p,l,c;e.UA.ie&&document.getSelection()&&"content"===document.getSelection().anchorNode.id||(o.removeClass("focused"),o.setHTML(""),s.contacts.abort=!0,s.hideDropdown=setTimeout(function(){s.contacts.hide()},150),(a=n?n.ancestor("[data-nsid]",!0):t.target.ancestor("[data-nsid]",!0))?(i=a.getData("nsid"),p=a.one("img").get("src"),r=a.getData("displayname")||"",l=a.getData("path-alias"),c="true"===a.getData("ispro"),s.addTemporaryPersonTag(r,i,p,l,c),s.addRemotePersonTag(i),s.contacts.hideFromSearch(i),s.contacts.hide(),s.contacts.abort=!0,s.get("container").one(".add-person").set("value",""),s.get("container").one(".add-person").focus()):s.contacts.hide())}}),this.registerEventHandler(o.on("focus",function(t){var o=this;t.preventDefault(),this.addClass("focused"),s.contacts.abort=!1,setTimeout(function(){e.UA.ie&&(o.addClass("focused"),o.focus()),o.set("text","")},40)})),this.registerEventHandler(o.on("keydown",function(e){13===e.keyCode&&(e.halt(),clearTimeout(s.hideDropdown),o.focus())})),this.registerEventHandler(o.on("blur",function(e){this.removeClass("focused")})),this.registerEventHandler(o.ancestor(".c-contact-search-autocomplete").on("focus",function(e){e.target.hasClass("c-contact-search-autocomplete")&&(clearTimeout(s.hideDropdown),o.focus())}))),t.one(".person-list")&&this.registerEventHandler(t.one(".person-list").on("click",function(e){e.target.hasClass("remove-person")?s.removeTag(e):e.target.ancestor("[data-loading]")&&e.preventDefault()})),this},removeTag:function(e){e.preventDefault();var t,n,a=e.target.ancestor("[data-person-nsid]"),s=e.target.ancestor("[data-person-tag-email]"),i=this.get("photoPeople").getValue("people");a?(t=a.getData("person-nsid"),a.setAttribute("data-loading",t),i.removeFromList(t,"id"),this.remoteRemoveTag(t),this.contacts.showInSearch(t)):s?(n=s.getData("person-tag-email"),s.setAttribute("data-loading",n),i.removeFromList(n,"email"),this.remoteRemoveTag(null,n)):o.warn("tried to remove invalid person tag.")},remoteRemoveTag:function(e,t){var o=this.get("container"),n=o.one(".person-list"),a=e?"userId":"email",s=e||t,i=this,r={photoId:this.photoId,coords:{x:0,y:0,w:0,h:0}};r[a]=s,this.get("peopleModel").remoteDelete(r).then(function(){var a=e?n.one('[data-person-nsid="'+e+'"]'):n.one('[data-person-tag-email="'+t+'"]');a&&a.remove(!0),n.one("li")||(o.one(".c-contact-search-autocomplete").setStyle("display","none"),o.addClass("empty"),i.fire("subviewViewEvent","tagsPeopleView:peopleEmpty"))},function(e){i.onError(i.intlMessage({intlName:"photo-page-scrappy.FAILED_TO_REMOVE_PERSON"}))})},addTemporaryPersonTag:function(e,t,o,n,a){this.addPerson({dataAttr:{key:"loading",value:t},buddyicon:o,size:50,displayname:e,isPro:this.appContext.flipper.isFlipped("enable-pro-badge")&&a,pathAlias:n||t,nsid:t,showRemove:!0})},addPerson:function(e){var t,o=this.get("container").one(".person-list");t=this.templates("sub-photo-person")(e),o.prepend(t)},addRemotePersonTag:function(e){var t=this.get("container").one(".person-list"),o=this,n=this.get("photoPeople")?this.get("photoPeople").getValue("people"):null;this.get("peopleModel").remoteCreate({photoId:this.photoId,userId:e,addedBy:o.get("me").getValue("nsid"),coords:{x:0,y:0,w:0,h:0}}).then(function(a){var s,i=t.one('[data-loading="'+e+'"]');i&&(i.removeAttribute("data-loading"),i.setAttribute("data-person-nsid",e)),s=o.get("peopleModel").add(a),n&&n.appendToList(s)},function(){t.one('[data-loading="'+e+'"]').remove(!0),o.onError(o.intlMessage({intlName:"photo-page-scrappy.PERSON_CANNOT_BE_TAGGED"}))})},canRemoveTag:function(e,t,o,n){return e||t&&o===t||n&&n===t},onError:function(t){new e.Views.FluidModal({appContext:this.appContext,title:this.intlMessage({intlName:"common.ERROR"}),message:t,actionButtonLabel:this.intlMessage({intlName:"common.OK"}),showCancelButton:!1}).show()}})},"@VERSION@",{requires:["flickr-view","hermes-template-sub-photo-person","hermes-template-invite-person","hermes-template-sub-photo-tags-people-section","url-helper","contact-search-box","html5-balls"],langBundles:["common","photo-page-scrappy"]});