YUI.add("photo-list-photo-view",function(e){var t=require("hermes-core/type-validator");e.namespace("Views")[this.name]=e.Base.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this.set("isZombie",!YUI.Env.isServer&&e.requiredToShowOnServer&&this.get("layoutItem")&&!this.get("layoutItem").isAwake),this},loadState:function(){var t=e.URLHelper.getPhotoPage({photoId:this.get("model").getValue("id"),pathAlias:this.get("model").getValue("owner").getValue("pathAlias"),contextSuffix:this.get("contextSuffix")});return this.set("photoPageUrl",t),e.Promise.resolve()},buildContainer:function(){var t,i=this.get("container"),r=this.get("layoutItem");if(r.isAwake)this.updateGeometry(),this.setContainerHTML(this.render()),YUI.Env.isServer?(i.setStyles({"background-image":"url("+this.get("photoUrl")+")"}),i.addClass("awake"),this.get("model").getValue("needsInterstitial")&&i.addClass("restricted-image")):(this.get("showLowResImageFirst")&&i.setStyles({backgroundImage:"url("+this.get("model").getValue("sizes").sq.url+")"}).addClass("low-res"),this.downloadCacheAndSetImage());else if(YUI.Env.isServer)this.set("isZombie",!0);else if(!YUI.Env.isServer||this.get("isZombie")){var a="";t=e.Node.create(this.get("placeHolderHTML")).set("innerHTML",this.render()),this.get("model").getValue("needsInterstitial")&&(a=" restricted-image"),t.setAttrs({id:i.getAttribute("id"),className:i.getAttribute("class")+a}),this.updateNodeGeometry(r,t),this.serialize(t),this.set("isReallySleeping",!0),this.set("isZombie",!1),this.downloadCacheAndSetImage()}return this.get("model").getValue("isVideo")&&this.get("container").addClass("is-video"),this.get("showInteractionBarPlaceholder")&&(this.get("model").getValue("aspectRatio")>1?i.addClass("landscape"):i.addClass("portrait")),this},activate:function(){var e;return this.renderInteractionView().then(function(e){this.fire("activated")}.bind(this)),this.get("showLowResImageFirst")&&((e=this.get("parentContainer").getDOMNode()).addEventListener("transitionend",this.removeTransition),e.addEventListener("webkitTransitionEnd",this.removeTransition)),this.registerEventHandler(this.get("interactionContainer").delegate(["blur","focus"],this.toggleKeyboardFocusStyling.bind(this),"a, .engagement-item")),this},toggleKeyboardFocusStyling:function(e){var t=e.target.ancestor(".interaction-view");t&&t.toggleClass("has-keyboard-focus")},setHoverVisible:function(e){var t=this.get("interactionContainer");t&&(e?t.addClass("manual-hover"):t.removeClass("manual-hover"))},render:function(){return this.templates("photo-list-photo")({photoPageUrl:this.get("photoPageUrl"),hasInteraction:!!this.get("interactionViewName")&&!this.appContext.forceServerRender,showInteractionBarPlaceholder:this.get("showInteractionBarPlaceholder"),isVideo:this.get("model").getValue("isVideo")})},removeTransition:function(e){e&&e.target&&e.target.classList&&e.target.classList.contains("photo-list-photo-view")&&e.target.classList.remove("low-res")},downloadCacheAndSetImage:function(){e.fluid.loadImage(this.get("photoUrl"),{timeout:1e3,retry:!0}).then(function(e){this.handleImageLoad(!0,e)}.bind(this),function(e){this.handleImageLoad(!1,e+"?retry="+Date.now())}.bind(this))},handleImageLoad:function(t,i){var r,a=this.get("isReallySleeping");(r=a?this.deserialize():this.get("container")).setStyle("backgroundImage","url("+i+")"),t||r.setStyle("backgroundColor","#eee"),this.get("model").getValue("needsInterstitial")&&r.addClass("restricted-image"),a?this.serialize(r):e.fluid.chill(function(){var e=this.get("container");a||(e.addClass("awake"),this.get("interactionView")&&this.get("interactionView").updateBreakpoints&&this.get("interactionView").updateBreakpoints(),this.fire(t?"loaded":"loadError"))},this),r=null},updateGeometry:function(e){var t,i=this.get("isReallySleeping");e?this.set("layoutItem",e):e=this.get("layoutItem"),t=i?this.deserialize():this.get("container"),this.updateNodeGeometry(e,t),i&&this.serialize(t),t=null},updateNodeGeometry:function(t,i){YUI.Env.isServer?i.setStyles({transform:"translate("+t.geometry.left+"px, "+t.geometry.top+"px)","-webkit-transform":"translate("+t.geometry.left+"px, "+t.geometry.top+"px)","-ms-transform":"translate("+t.geometry.left+"px, "+t.geometry.top+"px)"}):e.fluid.setStylePrefixed("transform","translate("+t.geometry.left+"px, "+t.geometry.top+"px)",i),i.setStyles({width:t.geometry.width+"px",height:t.geometry.height+"px"})},sleep:function(){var t,i;this.get("isReallySleeping")||(YUI.Env.isServer?this.set("isZombie",!0):(this.get("id"),this.destroyInteractionView(),(i=this.get("container")).removeClass("awake"),this.serialize(i),t=e.Node.create(this.get("placeHolderHTML")),this.get("parentContainer").replaceChild(t,i),this.set("container",t),this.set("isReallySleeping",!0),this.set("isZombie",!1),i=null))},wake:function(){var t,i,r;this.get("isReallySleeping")&&(this.get("id"),t=this.get("container"),i=this.get("parentContainer"),r=this.deserialize(),i.replaceChild(r,t),this.set("container",r),this.set("isReallySleeping",!1),this.renderInteractionView(),e.fluid.chill(function(){this.get("container").addClass("awake"),this.get("interactionView")&&this.get("interactionView").updateBreakpoints&&this.get("interactionView").updateBreakpoints()},this),t=null)},isAwake:function(){return!this.get("isReallySleeping")},serialize:function(t){if(YUI.Env.isServer)throw new Error("Impossible to `serialize` on the server (uses sessionStorage). Maybe you meant to call `sleep`?");t&&e.Storage.Instance.set(this.get("storageId"),t.getDOMNode().outerHTML)},deserialize:function(){if(YUI.Env.isServer)throw new Error("Impossible to `deserialize` on the server (uses sessionStorage). Maybe you meant to call `wake`?");var t,i=e.Storage.Instance.get(this.get("storageId"));return i&&(t=e.Node.create(i),this.dematerialize()),t},dematerialize:function(){if(YUI.Env.isServer)throw new Error("Impossible to `dematerialize` on the server (uses sessionStorage).");e.Storage.Instance.remove(this.get("storageId"))},renderInteractionView:function(){var t,i=this.get("interactionViewName"),r=this.get("interactionView");return i&&!r?this.appContext.getView(i,e.merge(this._params,{id:this.get("id"),container:this.get("interactionContainer"),model:this.get("model"),listModelParams:this.get("listModelParams"),photoPageUrl:this.get("photoPageUrl"),isActiveViewAgnostic:this.get("isActiveViewAgnostic"),engagementModelName:this.get("engagementModelName"),layoutWidth:this.get("layoutItem").geometry.width})).then(function(e){return this.set("interactionView",e),this.registerEventHandler(this.get("interactionView").on("curateOpened",this.setHoverVisible.bind(this,!0))),this.registerEventHandler(this.get("interactionView").on("curateClosed",this.setHoverVisible.bind(this,!1))),e.initialize()}.bind(this)):r?(r.get("container").inDoc()||((t=r.get("container")).addClass("interaction-view"),this.get("interactionContainer")||this.buildContainer(),this.get("container").replaceChild(t,this.get("interactionContainer")),r.normalizedActivate()),e.Promise.resolve(r)):e.Promise.resolve(null)},destroyInteractionView:function(){var e=this.get("interactionView");e&&(e.destroy(),this.set("interactionView",null))},destructor:function(){this.dematerialize()}},{ATTRS:{id:{writeOnce:"initOnly",validator:function(e,i){return t.photoId(e)}},parentSignature:{writeOnce:"initOnly"},storageId:{readOnly:!0,derivedBy:["id","parentSignature"],getter:function(){return this.get("parentSignature")+"-"+this.get("id")}},layoutItem:{validator:function(e,t){return"object"==typeof e&&e.hasOwnProperty("aspectRatio")&&e.hasOwnProperty("geometry")&&"object"==typeof e.geometry&&e.geometry.hasOwnProperty("width")&&e.geometry.hasOwnProperty("height")&&e.geometry.hasOwnProperty("top")&&e.geometry.hasOwnProperty("left")&&e.hasOwnProperty("isAwake")}},photoUrl:{value:"/images/spaceball.gif",getter:function(e,t){var i,r=this.get("model"),a=this.get("layoutItem"),n={};return this.get("showInteractionBarPlaceholder")?(r.getValue("aspectRatio")>1?n.height=a.geometry.height-(this.get("interactionBarHeight")||0):n.width=a.geometry.width,i=r.getSizeToFit(n,{includeSquare:1===a.aspectRatio})):i=r.getSizeToFit({width:a.geometry.width,height:a.geometry.height},{includeSquare:1===a.aspectRatio}),i.url}},photoPageUrl:{writeOnce:!0,validator:function(t,i){return e.AttributeHelpers.validateString(t)}},model:{value:null},listModelParams:{value:null},parentContainer:{writeOnce:"initOnly"},contextSuffix:{writeOnce:"initOnly",value:null,validator:function(t,i){return e.AttributeHelpers.validateString(t)}},measureAFT:{value:!1,validator:function(t,i){return e.AttributeHelpers.validateBoolean(t)}},isReallySleeping:{value:!1,validator:function(t,i){return e.AttributeHelpers.validateBoolean(t)}},isZombie:{value:!1,validator:function(t,i){return e.AttributeHelpers.validateBoolean(t)}},placeHolderHTML:{value:'<div class="youcansleepwhenyouredead" />',validator:function(t,i){return e.AttributeHelpers.validateString(t)}},showLowResImageFirst:{value:!1,validator:function(t,i){return e.AttributeHelpers.validateBoolean(t)}},interactionViewName:{writeOnce:"initOnly",value:null,validator:function(t,i){return e.AttributeHelpers.validateString(t)}},showInteractionBarPlaceholder:{writeOnce:"initOnly",value:!1,validator:function(t,i){return e.AttributeHelpers.validateBoolean(t)}},interactionBarHeight:{writeOnce:"initOnly",value:null,validator:function(t,i){return e.AttributeHelpers.validateInteger(t)}},engagementModelName:{writeOnce:"initOnly",value:null,validator:function(t,i){return e.AttributeHelpers.validateString(t)}},interactionView:{value:null},interactionContainer:{value:null,getter:function(e,t){return e||YUI.Env.isServer||(e=this.get("container").one(".interaction-view")),e}}}})},"@VERSION@",{requires:["flickr-view","hermes-template-photo-list-photo","url-helper","attribute-helpers"],optionalRequires:["fluid","storage-helper"],langBundles:["common"]});YUI.add("photo-list-view",function(t,e){"use strict";var i=require("hermes-core/flog")(e),o={containerWidth:"fullWidth",subtractScrollbarWidth:!1,pageParams:{page:1,perPage:50},parentName:"",subviewMapping:{"photo-models":{name:"photo-list-photo-view",params:null},"photo-lite-models":{name:"photo-list-photo-view",params:null},"set-models":{name:"photo-list-album-view",params:null}},paginateOnScroll:!0,keepAwakeOnScroll:!1,parentContainer:t.config.win,loadMoreMargin:3,relayoutOnResize:!0,recenterOnResize:!1,responsiveRowHeight:!1,maintainScrollPosition:!0,interactionViewName:"photo-list-photo-interaction-view",engagementModelName:"photo-engagement-models",itemFilterFunction:null,injectPhotolistContextParams:null,beaconViews:!0,scrollInterruptParams:null,scrollToWithId:!1,handleCollectionChanged:!1},n={480:.5,800:.75,1280:1,1600:1.25},a=Object.keys(n);t.FlickrView.create(this.name,t.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){var n,a=t.merge(o,e.photoListConfig);if(void 0===a)throw new Error("photo-list-view must be initialized with config params wrapped in a `photoListConfig` object.");if(a.initialItems)this.initialItems=a.initialItems.concat(),a.paginateOnScroll=!1;else{if(void 0===a.modelParams)throw new Error("photo-list-view must be initialized with `modelParams`.");if(void 0===a.modelParams.registryName)throw new Error("photo-list-view must be initialized with `modelParams.registryName`.");if(void 0===a.modelParams.modelIdOrAttributes)throw new Error("photo-list-view must be initialized with `modelParams.modelIdOrAttributes`.");if(void 0===a.modelParams.collectionAttributeName)throw new Error("photo-list-view must be initialized with `modelParams.collectionAttributeName`.")}if(void 0===a.parentName)throw new Error("photo-list-view must be initialized with the `parentName` (the name of the module containing the photolist).");return this.parentName=a.parentName,this.modelParams=a.modelParams,this.pageParams=a.pageParams,this.subviewMapping=a.subviewMapping,this.loadMoreMargin=a.loadMoreMargin,this.relayoutOnResize=a.relayoutOnResize,this.recenterOnResize=a.recenterOnResize,this.responsiveRowHeight=a.responsiveRowHeight,this.contextSuffix=a.contextSuffix,this.initializeWithFirstPage=a.initializeWithFirstPage,!YUI.Env.isServer&&a.beaconViews&&(this.viewBeaconer={beaconer:this.appContext.getViewCounter(),beaconAttribute:a.viewBeaconAttribute||"id",beaconRestrictedAttribute:a.viewBeaconRestrictedAttribute||"needsInterstitial",beaconAlwaysBeacon:a.viewBeaconAlwaysBeacon||!1,beaconIsOwnerAttribute:a.viewBeaconIsOwnerAttribute||"isOwner"}),a.subtractScrollbarWidth?YUI.Env.isServer?this.scrollbarWidth=this.appContext.viewportData.scrollbarWidth:this.scrollbarWidth=t.OverflowHelper.detectScrollbarSize(t.one("body")):this.scrollbarWidth=0,a.layout?(a.layout instanceof t.PhotoListLayout?(i.warn("Passing a PhotoListLayout instance into PhotoListView is deprecated. Instead, send the layout config object, and PhotoListView will create the PhotoListLayout for you."),this.photoListLayout=a.layout):(this.isMobile&&a.mobileLayout&&(0===Object.keys(a.mobileLayout).length&&(a.mobileLayout={targetRowHeight:200,containerPadding:{right:16,left:16},itemSpacing:{horizontal:16,vertical:16}}),a.layout.targetRowHeight=a.mobileLayout.targetRowHeight||a.layout.targetRowHeight,a.layout.containerPadding=t.merge(a.layout.containerPadding||{},a.mobileLayout.containerPadding||{}),a.layout.itemSpacing=t.merge(a.layout.itemSpacing||{},a.mobileLayout.itemSpacing||{})),this.photoListLayout=new t.PhotoListLayout(t.merge(a.layout,{appContext:this.appContext}))),delete a.layout.appContext):this.photoListLayout=new t.PhotoListLayout({appContext:this.appContext}),this.photoListLayout.containerWidth||(YUI.Env.isServer||(n=this.appContext.flapp.get("activeView")),this.appContext.hasClientSideRouted()&&n&&n.name===this.parentName?this.photoListLayout.containerWidth=this.calculateContainerWidth("previousContainerWidth"):(this.explicitContainerWidth=a.containerWidth,this.photoListLayout.containerWidth=this.calculateContainerWidth(this.explicitContainerWidth))),this.baseRowHeight=this.photoListLayout.targetRowHeight,this.responsiveRowHeight&&this.adjustRowHeightToContainerWidth(),this.paginateOnScroll=a.paginateOnScroll,this.paginateOnScroll&&this.photoListLayout.layout&&this.photoListLayout.hasLimitedNumberOfRows()&&i.warn("When photo-list-layout::maxNumRows is specified, photo-list::paginateOnScroll should probably be set to `false`."),this.parentContainer=a.parentContainer,this.keepAwakeOnScroll=a.keepAwakeOnScroll,this.keepAwakeOnScroll&&(this.photoListLayout.sleepTopAndBottom=!1),this.loadingMoreBottom=!1,this.loadingMoreTop=!1,this.lastItemCached=!1,this.firstItemCached=!1,this.itemsMappedToAspectRatios=[],this.lowestPageInView=this.pageParams.page,this.highestPageInView=this.pageParams.page,this.pageParams.viewPageSize&&(this.lastPageInView=this.pageParams.page+Math.ceil(this.pageParams.viewPageSize/this.pageParams.perPage)-1,isNaN(this.lastPageInView)&&i.warn("Error calculating `this.lastPageInView`. Verify values passed for `config.pageParams`.")),this.modelsById={},this.subviewsById={},this.fetchedOnlyInitPage=!1,this.perPageDoubles=0,this.interactionViewName=a.interactionViewName,this.showInteractionBarPlaceholder=a.showInteractionBarPlaceholder||!1,this.interactionBarHeight=a.interactionBarHeight,this.engagementModelName=a.engagementModelName,this.maintainScrollPosition=a.maintainScrollPosition,this.scrollToWithId=a.scrollToWithId,this.handleCollectionChanged=a.handleCollectionChanged,this.itemFilterFunction=a.itemFilterFunction,a.injectPhotolistContextParams&&(this.injectPhotolistContextParams=t.merge(a.injectPhotolistContextParams)),""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),a.scrollInterruptParams&&(this.scrollInterruptParams=a.scrollInterruptParams,this.scrollInterruptState={nextInterrupt:this.scrollInterruptParams.pageCounts[0],numPagesLoaded:0,numInterrupts:0,isInterrupted:!1,footer:null,footerHeight:0}),this.isHidden=a.isHidden,delete e.photoListConfig,this.params=e,this},loadState:function(){var e,o,n=this;return this.initialItems?this.setItems(this.initialItems).then(this.loadStateSubviewsReady.bind(this),function(t){i.error("Error displaying initial items",{err:t})}):(e=t.merge(this.modelParams.fetchParams,this.pageParams),this.paginateOnScroll&&!this.scrollToWithId&&(e.page=2*(this.pageParams.page-1)+1,e.perPage=Math.floor(.5*this.pageParams.perPage),this.fetchedOnlyInitPage=!0),this.appContext.getModel(this.modelParams.registryName,this.modelParams.modelIdOrAttributes,e).then(function(i){var a,s=i.getValue(n.modelParams.collectionAttributeName),r=s.getList();if(n.set("collectionModel",i),n.lastPageInView)return(o=Math.min(s.getNextIncompletePage(n.pageParams),n.lastPageInView+1))<=n.pageParams.page?s.getPage(e):(a=s.getList().slice((n.pageParams.page-1)*n.pageParams.perPage,(o-1)*n.pageParams.perPage),t.Promise.resolve(a));var l=(e.page||1)*(e.perPage||0);return r.length&&(s.fetchedEnd||r.length>=l)&&!n.initializeWithFirstPage?t.Promise.resolve(r):s.getPage(e)},function(t){i.error("error fetching model",{err:t})}).then(function(e){var i=n.get("collectionModel").getValue(n.modelParams.collectionAttributeName),a=i.getList(),s=i.getFirstItem(),r=i.getLastItem();return e&&e.length?(n.lastPageInView?(n.lowestPageInView=n.pageParams.page,o===n.lastPageInView?n.highestPageInView=o-(Math.floor(n.pageParams.viewPageSize/n.pageParams.perPage)-1):n.highestPageInView=Math.max(n.lowestPageInView,o)):n.initializeWithFirstPage?(n.lowestPageInView=1,n.highestPageInView=1):(n.lowestPageInView=Math.floor(s.index/n.pageParams.perPage)+1,n.highestPageInView=Math.floor(r.index/n.pageParams.perPage)+1),!YUI.Env.isServer&&n.scrollInterruptState&&n.updateScrollInterruptState(n.highestPageInView-1),i.fetchedEnd&&e.length&&a.length&&e[e.length-1]&&a[a.length-1]&&e[e.length-1].id===a[a.length-1].id?n.lastItemCached=!0:n.highestPageInView>=n.lastPageInView&&(n.lastItemCached=!0),n.itemFilterFunction&&"function"==typeof n.itemFilterFunction&&(e=e.filter(n.itemFilterFunction)),n.layOutItems(e,"bottom")):t.Promise.resolve(null)},function(t){i.error("Calculate layout and generate subviews",{err:t})}).then(this.loadStateSubviewsReady.bind(this),function(t){i.warn("Error loading items from registry",{err:t,registry:n.modelParams.registryName,modelIdOrAttributes:n.modelParams.modelIdOrAttributes})}))},loadStateSubviewsReady:function(t){this.photoListLayout.getAwakeItems().length;YUI.Env.isServer||this.get("container").hasClass("requiredToShowOnServer")&&this.photoListLayout.containerWidth!==this.retrieveContainerWidth()&&(this._relayoutQueued=!0)},buildContainer:function(){return this.setContainerHTML(""),this.get("container").setStyle("height",this.containerHeight+"px"),this.initialLayoutResponse&&(this.renderSubviews(null,this.initialLayoutResponse),delete this.initialLayoutResponse),this},activate:function(){var e;return this._relayoutQueued&&(this._relayoutQueued=!1,this.initialLayoutResponse?(this.buildContainer(),this.storeContainerWidth(this.photoListLayout.containerWidth)):this.handleResize(null)),!this.paginateOnScroll&&this.keepAwakeOnScroll||(this.handleScroll(),this.parentContainer!==t.config.win&&this.parentContainer instanceof t.Node?this.registerEventHandler(this.parentContainer.on("scroll",this.handleScroll.bind(this))):this.registerEventHandler(t.globalEvents.subscribe("window:scroll",this.handleScroll.bind(this)))),this.relayoutOnResize&&this.registerEventHandler(t.globalEvents.subscribe("window:resize",this.handleResize.bind(this))),!YUI.Env.isServer&&this.maintainScrollPosition?this.photoListLayout.hasLimitedNumberOfRows()||(!(e=this.appContext.getReferrer())||e&&e!==this.appContext.flapp.getPath())&&this.restoreScrollPosition():!YUI.Env.isServer&&this.scrollToWithId&&this.scrollToId(this.scrollToWithId),this.injectPhotolistContextParams&&this.registerEventHandler(this.get("container").delegate("click",this.injectPhotolistContext.bind(this),"a")),this.registerEventHandler(this.get("container").delegate("click",this.subviewExtraToolClicked.bind(this),".extra-tool")),this.registerEventHandler(this.get("container").delegate("key",this.subviewExtraToolClicked.bind(this),"down:13",".extra-tool")),Object.keys(this.subviewMapping).some(function(t){return this.subviewMapping[t]&&"photo-list-tile-view"===this.subviewMapping[t].name}.bind(this))&&this.registerEventHandler(this.get("container").delegate("mouseenter",this.subviewLicenseMouseenter.bind(this),".license")),this.handleCollectionChanged&&this.registerEventHandler(this.get("collectionModel").on("valuesChanged",this.onCollectionModelValuesChanged.bind(this))),this.isHidden&&this.hide(),this.activateSubviews(),this},setItems:function(t,e){var i,o=this;return this.containerHeight=0,this.itemsMappedToAspectRatios=[],this.modelsById={},this.subviewsById={},this.get("collectionModel")&&((i=this.get("collectionModel").getValue(this.modelParams.collectionAttributeName)).fetchedStart?this.firstItemCached=!0:this.firstItemCached=!1,i.fetchedEnd&&!e?this.lastItemCached=!0:this.lastItemCached=!1),this.get("container").setHTML(""),this.photoListLayout.clear(),this.get("showThrobberDuringLoad")&&this.toggleThrobber(!0),this.layOutItems(t,"bottom").then(function(t){o.get("showThrobberDuringLoad")&&o.toggleThrobber(!1)})},getContainingElementData:function(){var e,i=this.get("container");return e={height:0,scrollLeft:0,scrollTop:0},e=this.parentContainer!==t.config.win&&this.parentContainer instanceof t.Node?{height:this.parentContainer.get("offsetHeight"),scrollLeft:this.parentContainer.getDOMNode().scrollLeft,scrollTop:this.parentContainer.getDOMNode().scrollTop}:{height:this.appContext.viewportData.getHeight(),scrollLeft:YUI.Env.isServer?0:t.config.win.pageXOffset,scrollTop:YUI.Env.isServer?0:t.config.win.pageYOffset},i&&(e.scrollLeft-=i.get("offsetLeft"),e.scrollTop-=i.get("offsetTop")),e},setContainerScrollTop:function(e){this.parentContainer!==t.config.win&&this.parentContainer instanceof t.Node?this.parentContainer.getDOMNode().scrollTop=e:t.config.win.scrollTo(0,e)},setTargetRowHeight:function(t){return this.photoListLayout.updateTargetRowHeight(t),this.handleResize(null,!0)},getSubview:function(t){return this.subviewsById[t]},handleScroll:function(e){var i,o,n,a=this,s=this.get("container"),r=s.get("clientHeight"),l=this.getContainingElementData(),h=l.height,c=l.scrollTop,d=!0;if(!this.isHidden){i=s.get("offsetParent").get("offsetTop")-s.get("offsetTop")+r,n=c+h;for(var u in this.subviewsById){d=!1;break}d||(!this.paginateOnScroll||this.scrollInterruptState&&this.scrollInterruptState.isInterrupted||((!this.lastPageInView||this.highestPageInView<this.lastPageInView)&&i-n<this.loadMoreMargin*h&&this.loadMore("bottom"),!this.lastPageInView&&c<this.loadMoreMargin*h&&this.lowestPageInView>1&&this.loadMore("top")),this.keepAwakeOnScroll||(o=this.photoListLayout.computeWakeSleep(l.scrollTop,l.scrollLeft),this.wakeOrSleepSubviews(o.wakeSleepChangedItems),!YUI.Env.isServer&&this.viewBeaconer&&o.inViewportChangedItems&&this.processInViewportItems(o.inViewportChangedItems)),void 0!==e&&(this.afterScrollTimeoutId&&t.config.win.clearTimeout(this.afterScrollTimeoutId),this.afterScrollTimeoutId=t.config.win.setTimeout(function(){a.paginateOnScroll&&a.storeScrollPosition(),a.paginateOnScroll&&!a.keepAwakeOnScroll&&a.validateWakeSleep(o),delete a.afterScrollTimeoutId},250)))}},handleResize:function(t,e){this.responsiveRowHeight&&this.adjustRowHeightToContainerWidth();var i,o,n=this.calculateContainerWidth(),a=this.get("container"),s=this.getContainingElementData(),r={diffType:"relayout",firstPage:this.firstItemCached,lastPage:this.lastItemCached};if(e||n-this.scrollbarWidth!==this.photoListLayout.containerWidth)return this.storeContainerWidth(n),this.photoListLayout.containerWidth=n-this.scrollbarWidth,i=this.photoListLayout.computeLayout(null,s.scrollTop,s.scrollLeft,r),this.containerHeight=i.containerHeight,this.scrollInterruptState&&this.scrollInterruptState.isInterrupted&&this.scrollInterruptState.loadMoreElement&&this.scrollInterruptState.loadMoreElement.setStyle("width",this.photoListLayout.containerWidth+"px"),a.setStyle("height",i.containerHeight+"px"),o=this.updateSubviews(i,"bottom"),this.recenterOnResize&&this.scrollToCenterItem(i.allLayoutItems),o},loadMore:function(e){"search-photos-lite-models"===this.modelParams.registryName&&this.modelParams.fetchParams&&this.modelParams.fetchParams.apiParams&&void 0!==this.modelParams.fetchParams.apiParams.page&&delete this.modelParams.fetchParams.apiParams.page;var o=this,n=this.get("collectionModel").getValue(this.modelParams.collectionAttributeName),a=n.getList(),s=t.merge(this.modelParams.fetchParams,this.pageParams);if("bottom"!==e||this.loadingMoreBottom)"top"!==e||this.loadingMoreTop||(s.page=this.lowestPageInView-1,o.lowestPageInView>1&&(this.loadingMoreTop=!0,n.getPage(s).then(function(t){n.fetchedStart&&t[0].id===n.getList()[0].id&&(o.firstItemCached=!0),o.lowestPageInView=o.lowestPageInView-1,o.layOutItems(t,e).then(function(t){o.loadingMoreTop=!1,o.paginateOnScroll&&(s.page<=0?i.warn("loadMore fetching beyond start of collection; aborting",{params:s}):o.handleScroll())})},function(t){i.error("loadMore page fetch failed",{err:t}),o.toggleThrobber(!1)})));else{if(this.fetchedOnlyInitPage?(s.page=2*(this.pageParams.page-1)+2,s.perPage=Math.floor(.5*this.pageParams.perPage)):s.page=this.highestPageInView+1,n.fetchedEnd&&this.lastItemCached)return;this.loadingMoreBottom=!0,this.scrollInterruptParams&&this.scrollInterruptParams.footerToHideWhileScrolling&&!this.scrollInterruptState.footer&&(this.scrollInterruptState.footer=t.one(this.scrollInterruptParams.footerToHideWhileScrolling),this.scrollInterruptState.footer&&(this.scrollInterruptState.footerHeight=this.scrollInterruptState.footer.get("clientHeight"),this.setFooterDisplay(!1))),this.get("showThrobberDuringLoad")&&this.toggleThrobber(!0),n.getPage(s).then(function(t){a=n.getList(),n.fetchedEnd&&t[t.length-1].id===a[a.length-1].id&&(o.lastItemCached=!0),o.fetchedOnlyInitPage?o.fetchedOnlyInitPage=!1:(s.perPageDoubling&&o.perPageDoubles<s.perPageDoubling&&(o.perPageDoubles++,o.pageParams.perPage*=2,o.highestPageInView=Math.floor(.5*o.highestPageInView),o.lastPageInView=Math.floor(.5*o.lastPageInView)),o.highestPageInView=o.highestPageInView+1),o.highestPageInView>=o.lastPageInView&&(o.lastItemCached=!0),o.itemFilterFunction&&"function"==typeof o.itemFilterFunction&&(t=t.filter(o.itemFilterFunction)),o.layOutItems(t,e).then(function(t){o.loadingMoreBottom=!1,o.paginateOnScroll&&(n.totalItems&&(s.page-1)*s.perPage>n.totalItems?i.warn("loadMore fetching beyond end of collection; aborting",{params:s,total:n.totalItems}):o.handleScroll())}),o.scrollInterruptState&&(o.lastItemCached?o.setFooterDisplay(!0):(o.scrollInterruptState.numPagesLoaded++,o.checkScrollInterruptionState())),o.get("showThrobberDuringLoad")&&o.toggleThrobber(!1)},function(t){i.error("loadMore page fetch failed",{err:t}),o.toggleThrobber(!1)})}},layOutItems:function(e,o,n){if(!e||!e.length)return t.Promise.resolve();var a,s,r,l=this.containerHeight,h={},c=this.get("container"),d=this.getContainingElementData();if(e=this.cacheModelsById(e),a=this.itemsToAspectRatios(e),"bottom"===o)this.itemsMappedToAspectRatios=this.itemsMappedToAspectRatios.concat(a),s=a,h.diffType="append",this.lastItemCached&&(h.lastPage=!0);else{if("top"!==o)return void i.warn("Unsupported `layOutItems` direction",{direction:o});this.itemsMappedToAspectRatios=a.concat(this.itemsMappedToAspectRatios),s=a,h.diffType="prepend",this.firstItemCached&&(h.firstPage=!0)}return n&&(h.diffType="relayout",h.diffDirection=o),r=this.photoListLayout.computeLayout(s,d.scrollTop,d.scrollLeft,h),c.setStyle("height",r.containerHeight+"px"),this.containerHeight=r.containerHeight,"top"===o&&this.setContainerScrollTop(this.containerHeight-l),this.updateSubviews(r,o)},updateSubviews:function(t,e){var o,n=this;return this.instantiateSubviews(t.newItems).then(function(i){return i=i.filter(function(t){return!!t}),n.updateSubviewGeometry(t.layoutChangedItems),n.isBuilt?(n.renderSubviews(i,t,e),n.activateSubviews(i),t.wakeSleepChangedItems.length&&(o=t.wakeSleepChangedItems.filter(function(e){return-1===t.newItems.indexOf(e)})).length&&n.wakeOrSleepSubviews(o),t.inViewportChangedItems.length&&n.processInViewportItems(t.inViewportChangedItems)):n.initialLayoutResponse=t,i},function(t){i.error("Error instantiating subviews",{err:t})})},instantiateSubviews:function(e){var o,n=[],a=this,s=this.get("container");e.forEach(function(e){(o=a.modelsById[e.id])?a.subviewsById[e.id]?n.push(t.Promise.resolve(a.subviewsById[e.id])):n.push((function(o,n){var r=t.merge(a.params,{id:e.id,parentSignature:a.getPhotolistSignature(),model:o,contextSuffix:a.contextSuffix,layoutItem:n,parentContainer:s,interactionViewName:a.interactionViewName,showInteractionBarPlaceholder:a.showInteractionBarPlaceholder,interactionBarHeight:a.interactionBarHeight,engagementModelName:a.engagementModelName}),l=a.subviewMapping[o.registry.name];return l.params&&(r=t.merge(r,l.params)).removePoolPhoto&&(r.listModelParams=a.modelParams),a.instantiateSubview(l.name,r).then(function(t){return t.initialize().then(function(t){return a.subviewsById[n.id]=t,a.subviews={},t},function(t){return i.warn("Error in lifecycle of subview",{err:t,view:l.name}),a.photoListLayout.invalidateItem(n.id),null})},function(t){i.warn("Error instantiating subview",{err:t,view:l.name})})})(o,e)):i.warn("Model missing from cache",{modelId:e.id})});var r=t.Promise.all(n);return r.then(function(t){return!YUI.Env.isServer&&a.viewBeaconer&&a.viewBeaconer.beaconer.flushQueue({avoidDuplicates:!0}),t}),r},renderSubviews:function(t,e,o){var n,a,s,r,l=this.get("container"),h=this;t||(t=[],e.allLayoutItems.forEach(function(e){var i=h.subviewsById[e.id];i&&t.push(i)})),o||(o="bottom"),YUI.Env.isServer?(n=t.map(function(t){return t.get("container").get("outerHTML")}),"top"===o?l.setHTML(n.join("")+l.getHTML()):"bottom"===o?l.setHTML(l.getHTML()+n.join("")):(i.warn("Unsupported `renderSubviews` direction; appending changed subviews.",{direction:o}),l.setHTML(l.getHTML()+n.join("")))):("top"===o&&t.reverse(),a=YUI.config.doc.createDocumentFragment(),t.forEach(function(t){t&&a.appendChild(t.get("container").getDOMNode())}),"top"===o?l.prepend(a):"bottom"===o?l.append(a):(i.warn("Unsupported `renderSubviews` direction; appending changed subviews.",{direction:o}),l.append(a))),s=e.wakeSleepChangedItems.filter(function(t){return-1!==e.newItems.indexOf(t)}),this.updateSubviewGeometry(s),this.keepAwakeOnScroll?(r=e.wakeSleepChangedItems.filter(function(t){return-1!==e.leadingOrphans.indexOf(t)||-1!==e.trailingOrphans.indexOf(t)}),s.forEach(function(t){t.isAwake=!0}),this.wakeOrSleepSubviews(s.concat(r))):this.wakeOrSleepSubviews(e.wakeSleepChangedItems)},updateSubviewGeometry:function(t){var e,o=this;t.forEach(function(t){(e=o.subviewsById[t.id])?e.updateGeometry?e.updateGeometry(t):e.get("container").setStyles({width:t.geometry.width+"px",height:t.geometry.height+"px",transform:"translate("+t.geometry.left+"px, "+t.geometry.top+"px)","-webkit-transform":"translate("+t.geometry.left+"px, "+t.geometry.top+"px)","-ms-transform":"translate("+t.geometry.left+"px, "+t.geometry.top+"px)"}):i.warn("Subview missing from cache for geometry update",{layoutItemId:t.id})})},wakeOrSleepSubviews:function(t){var e,o=this;t.forEach(function(t){(e=o.subviewsById[t.id])?e.wake&&e.sleep?t.isAwake?e.wake():e.sleep():e.get("container").setStyle("display",t.isAwake?"":"none"):i.warn("Subview missing from cache for wake/sleep update",{layoutItemId:t.id})})},processInViewportItems:function(e){var i,o=this;e.forEach(function(e){if(e.isInViewport){if(!(i=o.subviewsById[e.id]))return;!YUI.Env.isServer&&o.viewBeaconer&&o.viewBeaconer.beaconer&&i.get("model").registry.hasAttribute(o.viewBeaconer.beaconIsOwnerAttribute)&&!i.get("model").getValue(o.viewBeaconer.beaconIsOwnerAttribute)&&(o.viewBeaconer.beaconAlwaysBeacon||i.get("model").registry.hasAttribute(o.viewBeaconer.beaconRestrictedAttribute)&&!i.get("model").getValue(o.viewBeaconer.beaconRestrictedAttribute))&&o.viewBeaconer.beaconer.queue(i.get("model").getValue(o.viewBeaconer.beaconAttribute),t.config.win.document.location.href)}})},activateSubviews:function(t){if(!t){t=[];for(var e in this.subviewsById)t.push(this.subviewsById[e])}t.forEach(function(t){t.normalizedActivate()})},removeItems:function(t){var e=this;t.forEach(function(t){e.photoListLayout.invalidateItem(t.id),e.itemsMappedToAspectRatios=e.itemsMappedToAspectRatios.filter(function(e){return e.id!==t.id}),e.modelsById[t.id]&&delete e.modelsById[t.id],e.subviewsById[t.id]&&(e.subviewsById[t.id].destroy({remove:!0}),delete e.subviewsById[t.id])})},onCollectionModelValuesChanged:function(t,e){var i,o,n,a,s;if(t[this.modelParams.collectionAttributeName]&&t[this.modelParams.collectionAttributeName].listDiff&&(i=t[this.modelParams.collectionAttributeName].listDiff,!this.loadingMoreBottom&&!this.loadingMoreTop)){if(o=this.get("collectionModel").getValue(this.modelParams.collectionAttributeName),n=o.getList(),i.added.length){var r,l,h,c;a=i.added,-1!==(r=n.indexOf(a[0])-1)&&(l=n[r])&&this.modelsById[l.id]&&(s="bottom",o.fetchedEnd&&a[a.length-1].id===n[a.length-1].id&&(this.lastItemCached=!0)),-1!==(h=n.indexOf(a[a.length-1])+1)&&(c=n[h+1])&&this.modelsById[c.id]&&(s="top",o.fetchedStart&&a[0].id===n[0].id&&(this.firstItemCached=!0)),s&&this.layOutItems(a,s,e)}i.removed.length&&(this.removeItems(i.removed),this.handleResize(null,!0))}},toggleThrobber:function(t){var e=this.get("container");void 0===t&&(t=!this.get("isThrobberShowing")),t?(e.setStyle("height",this.containerHeight+100+"px"),e.setStyle("position","relative"),this.get("throbberNode").appendTo(e)):(this.get("throbberNode").remove(),e.setStyle("position","initial")),this._set("isThrobberShowing",t)},checkScrollInterruptionState:function(t){if(this.scrollInterruptState||t){var e;if(this.scrollInterruptState.numPagesLoaded>=this.scrollInterruptState.nextInterrupt){if(this.scrollInterruptState.numInterrupts++,e=this.scrollInterruptParams.pageCounts[this.scrollInterruptParams.pageCounts.length-1],this.scrollInterruptState.numInterrupts>=this.scrollInterruptParams.pageCounts.length)switch(this.scrollInterruptParams.repeatMode){case"exponential":this.scrollInterruptState.nextInterrupt+=e*Math.pow(2,this.scrollInterruptState.numInterrupts-this.scrollInterruptParams.pageCounts.length);break;case"linear":default:this.scrollInterruptState.nextInterrupt+=e}else this.scrollInterruptState.nextInterrupt+=this.scrollInterruptParams.pageCounts[this.scrollInterruptState.numInterrupts];t||this.interruptScroll()}else this.get("container").setStyle("paddingBottom","0px")}},updateScrollInterruptState:function(t){this.scrollInterruptState.numPagesLoaded=t;for(var e=0;e<=t;e++)this.checkScrollInterruptionState(!0)},interruptScroll:function(){this.scrollInterruptState.isInterrupted||(this.scrollInterruptState.isInterrupted=!0,this.scrollInterruptState.loadMoreElement||(this.scrollInterruptState.loadMoreElement=t.Node.create(this.templates("infinite-scroll-load-more")({}))),this.get("container").append(this.scrollInterruptState.loadMoreElement),this.scrollInterruptState.loadMoreElementHeight||(this.scrollInterruptState.loadMoreElementHeight=parseInt(this.scrollInterruptState.loadMoreElement.getComputedStyle("height").replace("px",""),10)+20,this.registerEventHandler(this.scrollInterruptState.loadMoreElement.on("click",this.onLoadMoreClicked.bind(this))),this.scrollInterruptState.loadMoreElement.setStyles({width:this.photoListLayout.containerWidth+"px",bottom:this.photoListLayout.containerPadding.bottom+"px"})),this.setFooterDisplay(!0),this.get("container").setStyle("paddingBottom",this.scrollInterruptState.loadMoreElementHeight+"px"))},onLoadMoreClicked:function(e){var i,o=t.config.win.pageYOffset;this.scrollInterruptState.isInterrupted&&(this.scrollInterruptState.isInterrupted=!1,this.scrollInterruptState.loadMoreElement.remove(),this.setFooterDisplay(!1),this.get("container").setStyle("paddingBottom",this.scrollInterruptState.footerHeight+this.scrollInterruptState.loadMoreElementHeight-100+"px"),this.loadMore("bottom"),i=t.config.win.pageYOffset,t.config.win.scrollBy(0,o-i))},setFooterDisplay:function(t){this.scrollInterruptState.footer&&(t?this.scrollInterruptState.footer.removeClass("infinite-scroll-hide-footer"):this.scrollInterruptState.footer.addClass("infinite-scroll-hide-footer"),this.fire("subviewViewEvent","footerDisplayChanged"))},cacheModelsById:function(t){if(t&&t.length){var e=this.modelsById,i=[];return t.forEach(function(t){t&&!e[t.id]&&(e[t.id]=t,i.push(t))}),i}},itemsToAspectRatios:function(t){var e=[],i=this.photoListLayout.forceAspectRatio,o=void 0!==i&&!isNaN(i),n=i||1;return t.forEach(function(t){void 0!==t&&e.push({id:t.id,aspectRatio:o?n:t.getValue("aspectRatio")})}),e},calculateContainerWidth:function(e){if(e||(e=this.explicitContainerWidth),"number"==typeof e)return e;var i,o;switch(e){case"previousContainerWidth":o=this.getContainerWidthFromCache();break;case"fullWidth":default:YUI.Env.isServer||(this.isActiveAndInDOM()?o=this.get("container").get("clientWidth")-this.scrollbarWidth:(i=this.get("container"),this.isBuilt&&i||(i=t.one("."+this.parentName)),i&&(o=parseInt(i.getStyle("width"))))),o||(o=this.getContainerWidthFromCache())}return o},getContainerWidthFromCache:function(){var t;return(t=this.retrieveContainerWidth())||(t=this.appContext.viewportData.getWidth()-this.scrollbarWidth),this._relayoutQueued=!0,t},adjustRowHeightToContainerWidth:function(t){var e,i,o,s,r;if((t=this.calculateContainerWidth(t))<a[0])i=this.baseRowHeight*n[a[0]];else if(t>a[a.length-1])i=this.baseRowHeight*n[a[a.length-1]];else for(r=0;r<a.length-1;r++)if(o=a[r],s=a[r+1],(e=(t-o)/(s-o))>=0&&e<=1){i=this.baseRowHeight*n[o]+e*this.baseRowHeight*(n[s]-n[o]);break}this.photoListLayout.targetRowHeight=i},storeContainerWidth:function(t){var e=this.parentName;e&&this.appContext.viewportData.setContainerWidth(e,t)},retrieveContainerWidth:function(){var t=this.parentName;return t?this.appContext.viewportData.getContainerWidth(t):0},getLayoutItemsOnScreen:function(t){if(YUI.Env.isServer)return[];var e,i,o=this.get("container"),n=this.getContainingElementData();return e=n.scrollTop-o.getXY()[1],i=e+n.height,t||(t=this.photoListLayout.getCurrentLayout())?t.filter(function(t){return t.geometry.top+t.geometry.height>e&&t.geometry.top<i}):[]},scrollToCenterItem:function(e){if(!this.photoListLayout.hasLimitedNumberOfRows()&&0!==this.getContainingElementData().scrollTop){var i,o=this.photoListLayout.getCurrentLayout(),n=this.get("container").getXY()[1],a=this;this.layoutItemAtScreenCenter||(i=this.getLayoutItemsOnScreen(o),this.layoutItemAtScreenCenter=i[Math.floor(.5*i.length)]),e.some(function(e){if(e.id===a.layoutItemAtScreenCenter.id)return a.parentContainer!==t.config.win&&a.parentContainer instanceof t.Node?a.parentContainer.getDOMNode().scrollTop=n+e.geometry.top+.5*(e.geometry.height-a.parentContainer.get("offsetHeight")):t.config.win.scrollTo(0,n+e.geometry.top+.5*(e.geometry.height-a.appContext.viewportData.getHeight())),!0}),this.deleteResizeCenterTimeoutId&&t.config.win.clearTimeout(this.deleteResizeCenterTimeoutId),this.deleteResizeCenterTimeoutId=t.config.win.setTimeout(function(){a.layoutItemAtScreenCenter&&(delete a.layoutItemAtScreenCenter,delete a.deleteResizeCenterTimeoutId)},1e3)}},storeScrollPosition:function(){var e=this.getLayoutItemsOnScreen();e.length&&t.StorageHelper.setItem(this.getPhotolistSignature(),e[0].id,!0)},restoreScrollPosition:function(){this.scrollToId(null,!0)},scrollToId:function(e,i){var o,n,a=this.get("container");e||(e=t.StorageHelper.getItem(this.getPhotolistSignature(),!0)),
(o=this.photoListLayout.getLayoutItem(e))&&(!o.geometry||o.geometry.top-this.photoListLayout.containerPadding.top<=0||(n=a.get("offsetParent")?a.get("offsetParent").get("offsetTop")+a.get("offsetTop"):a.get("offsetTop"),t.one(".global-nav-view")&&!i&&(n-=t.one(".global-nav-view").get("offsetHeight")),t.one(".fluid-subnav")&&!i&&(n-=t.one(".fluid-subnav").get("offsetHeight")),i&&(n+=50),this.setContainerScrollTop(o.geometry.top+n)))},validateWakeSleep:function(t){var e,i,o,n,a=this.photoListLayout.getAwakeItems(),s=t.allLayoutItems.indexOf(a[0]),r=t.allLayoutItems.indexOf(a[a.length-1]),l=[];for(e=s;e<r;e++)i=t.allLayoutItems[e],(o=this.subviewsById[i.id])&&((n=!i.isAwake)||(n=o.isAwake?!o.isAwake():0===o.get("container").get("children").size()),n&&i&&(i.isAwake=!0,l.push(i)));l.length&&this.wakeOrSleepSubviews(l)},getPhotolistSignature:function(){var e,i,o,n=0;if(!this.signature){if(YUI.Env.isServer){if(e=this.appContext.request.path,this.appContext.request.query)for(i in this.appContext.request.query)t.config.flickr.routing_params.indexOf(i)<0&&(e+=i+this.appContext.request.query[i]);e=t.flutil.normalizeURIComponents(e)}else e=t.flutil.normalizeURIComponents(t.config.win.location.pathname+t.config.win.location.search);if(this.modelParams)if("string"!=typeof this.modelParams.modelIdOrAttributes)for(i in this.modelParams.modelIdOrAttributes)e+=i+""+this.modelParams.modelIdOrAttributes[i];else e+=this.modelParams.modelIdOrAttributes;for(this.parentName&&(e+=this.parentName),e=(e=e.toLowerCase()).replace(/\W/g,""),o=0;o<e.length;o++)n+=e.charCodeAt(o);this.signature="photolist-"+n.toString(36)}return this.signature},injectPhotolistContext:function(e){var o,n,a,s,r,l,h,c,d=e.currentTarget.getAttribute("href"),u=t.URLHelper.PHOTOPAGE_PATTERN.exec(d),g="";if(u&&u.length>=5){if(o=this.get("collectionModel").getValue(this.modelParams.collectionAttributeName).getList().map(function(t){return t.id}).filter(function(t){return!!t}),s=u[4],-1===(r=o.indexOf(s)))return void i.warn("Clicked photo id not found in photolist. Aborting photolist injection and passing through to photopage.");(n=o.slice(r,r+50)).length<50&&(a=Math.max(0,r-(50-n.length)),n=o.slice(a,r).concat(n)),d.indexOf("#")>-1&&(d=(c=d.split("#"))[0],g="#"+c[1]),"/"===d.substr(-1)&&(d=d.substr(0,d.length-1)),l=d+"/in/photolist-"+t.URLHelper.generateShortenedPhotolist(n)+g,e.halt(),this.injectPhotolistContextParams&&this.injectPhotolistContextParams.rapidBeaconConfig&&((h={})[this.injectPhotolistContextParams.rapidBeaconConfig.itemIndexKey]=r+1,t.rapidTracker.beacon(this.name,this.injectPhotolistContextParams.rapidBeaconConfig.beaconName,h)),e.metaKey||e.ctrlKey||e.which&&2===e.which?t.config.win.open(l,"_blank"):this.appContext.flapp.navigate(l)}},subviewExtraToolClicked:function(e){var i,o=e.target.getDOMNode(),n=o.dataset.id,a=this.modelsById[n];if(n&&a){if(o.classList.contains("more-menu")){var s=[],r=o.dataset.menuItems.split(",");r&&(r.indexOf("search-similar")>-1&&s.push({text:this.intlMessage({intlName:"common.SEARCH_FOR_SIMILAR_PHOTOS"}),callback:function(e,i){var o=a.getValue("similaritySearchURL");i.metaKey||i.ctrlKey||i.which&&2===i.which?t.config.win.open(o,"_blank"):this.appContext.flapp.navigate(o)}.bind(this)}),r.indexOf("search-similar-with-term")>-1&&"search-photos-lite-models"===this.modelParams.registryName&&this.modelParams.fetchParams&&this.modelParams.fetchParams.apiParams&&this.modelParams.fetchParams.apiParams.text&&s.push({text:this.intlMessage({intlName:"common.SEARCH_FOR_SIMILAR_PHOTOS_WITH_TERM"}),callback:function(e,i){var o=a.getValue("basicSimilaritySearchURL")+"&text="+this.modelParams.fetchParams.apiParams.text;i.metaKey||i.ctrlKey||i.which&&2===i.which?t.config.win.open(o,"_blank"):this.appContext.flapp.navigate(o)}.bind(this)}),r.indexOf("exclude-people")>-1&&s.push({text:this.intlMessage({intlName:"common.HIDE_PHOTOS_FROM_PERSON"}),callback:function(){this.fire("subviewViewEvent","bigScotch",a.getValue("ownerNsid"),n)}.bind(this)}),r.indexOf("ban-user")>-1&&(i=function(t){this.fire("subviewViewEvent","banUser"+(t?"AndRemove":""),a.getValue("owner").id)},s.push({text:this.intlMessage({intlName:"common.GROUP_BAN_USER"}),callback:i.bind(this,!1)}),s.push({text:this.intlMessage({intlName:"common.GROUP_BAN_USER_REMOVE_PHOTOS"}),callback:i.bind(this,!0)})),r.indexOf("remove-user")>-1&&(i=function(t){this.fire("subviewViewEvent","removeUser"+(t?"AndRemove":""),a.getValue("owner").id)},s.push({text:this.intlMessage({intlName:"common.GROUP_REMOVE_USER"}),callback:i.bind(this,!1)}),s.push({text:this.intlMessage({intlName:"common.GROUP_REMOVE_USER_REMOVE_PHOTOS"}),callback:i.bind(this,!0)}))),s.length&&this.openSubviewMenu(e.target,s,this.subviewsById[n])}else o.classList.contains("remove-photo")?(this.fire("subviewViewEvent","photoList:removePhoto",n),o.classList.contains("remove-fave")?this.appContext.getModelRegistry(this.engagementModelName).then(function(e){return e.remoteDelete({photoId:n,userId:this.modelParams.modelIdOrAttributes.id||this.modelParams.modelIdOrAttributes}).then(function(t){this.get("collectionModel").getValue(this.modelParams.collectionAttributeName).remove(a)}.bind(this),function(e){new t.Views.FluidModal({appContext:this.appContext,title:this.intlMessage({intlName:"common.OOPS"}),showActionButton:!0,showCancelButton:!1,textMessage:this.intlMessage({intlName:"common.PHOTO_REMOVE_ERROR"})}).show()}.bind(this))}.bind(this)):o.classList.contains("remove-group-pool")?this.get("collectionModel").removePhotoRemote(n).then(function(t){this.get("collectionModel").getValue(this.modelParams.collectionAttributeName).remove(a)}.bind(this),function(e){new t.Views.FluidModal({appContext:this.appContext,title:this.intlMessage({intlName:"common.OOPS"}),showActionButton:!0,showCancelButton:!1,textMessage:this.intlMessage({intlName:"common.PHOTO_REMOVE_ERROR"})}).show()}.bind(this)):o.classList.contains("remove-showcase-photo")?this.fire("subviewViewEvent","showcase:remove",a,n):o.classList.contains("remove-photosof-you")?this.fire("subviewViewEvent","photosofyou:remove",a,n):o.classList.contains("remove-own-photo")&&this.fire("subviewViewEvent","ownphoto:remove",a,n)):o.classList.contains("big-scotch")&&this.fire("subviewViewEvent","scotch:big",a.getValue("ownerNsid"),n);e.halt()}},openSubviewMenu:function(e,i,o){var n,a,s,r,l,h=new t.Views.FluidDroparound({appContext:this.appContext,showDropArrow:!0,observePageResize:!0,anchorElement:e,positionFixed:!1,preferBottom:!0,dismissOnOverlayClick:!0,closeOnScroll:!0,mirrorArrowAdjustment:-3,menuItems:i}),c=this;this.registerEventHandler(h.on("selected",function(t){t&&t.menuItem&&t.menuItem.callback&&t.menuItem.callback(t.menuItem.selected,t.origEvent)})),l=h.on("closeDroparound",function(t){c.detachRegisteredEvent(l),c.detachRegisteredEvent(n),c.detachRegisteredEvent(a),s&&clearTimeout(s),o.setHoverVisible&&o.setHoverVisible(!1)}),this.registerEventHandler(l),h.show(),n=h.get("container").on("mouseleave",function(t){if(h){var e=o.get("container");if(e){var i=e.getDOMNode().getBoundingClientRect();(t.clientX<i.left||t.clientX>i.right||t.clientY<i.top||t.clientY>i.bottom)&&h.close()}}}),this.registerEventHandler(n),a=t.one("document").on("mousemove",t.betterThrottle(function(t){s&&clearTimeout(s),s=setTimeout(function(){r(t)},200)})),this.registerEventHandler(a),r=function(t){if(h){var e=h.getDroparoundContainer(),i=o.get("container");if(i&&e){var n=i.getDOMNode().getBoundingClientRect(),a=e.getDOMNode().getBoundingClientRect();!(t.clientX<n.left||t.clientX>n.right||t.clientY<n.top||t.clientY>n.bottom)||t.clientX>a.left&&t.clientX<a.right&&t.clientY>a.top&&t.clientY<a.bottom||h.close()}}},o.setHoverVisible&&o.setHoverVisible(!0)},subviewLicenseMouseenter:function(e){var i,o=e.currentTarget&&e.currentTarget.getData("license-type")&&e.currentTarget.getData("license-type").toString();o&&(this.licenseTooltipHoverTimer&&clearTimeout(this.licenseTooltipHoverTimer),this.licenseTooltip&&this.licenseTooltip.close(),this.licenseTooltipHoverTimer=setTimeout(function(){this.licenseTooltip=new t.Views.FluidDroparound({appContext:this.appContext,anchorElement:e.target,showDropArrow:!0,positionFixed:!1,preferBottom:!0,invisibleOverlay:!0,autoSizeToContent:!0,width:300,classList:"license-tooltip",htmlMessage:this.templates("license-detail")({title:"common.LICENSE_TITLE_"+o,body:"common.LICENSE_DESC_"+o})}),this.licenseTooltip.show()}.bind(this),300),i=this.get("container").delegate("mouseleave",function(t){this.licenseTooltip&&this.licenseTooltip.close(),i.detach(),clearTimeout(this.licenseTooltipHoverTimer)}.bind(this),".license"),this.registerEventHandler(i))},show:function(){this.isHidden=!1,this.get("container").setStyle("display","block")},hide:function(){this.isHidden=!0,this.get("container").setStyle("display","none")}},{ATTRS:{showThrobberDuringLoad:{value:!0,validator:function(e,i){return t.AttributeHelpers.validateBoolean(e)}},isThrobberShowing:{readOnly:!0,value:!1},throbberNode:{readOnly:!0,getter:function(e){return YUI.Env.isServer||void 0!==e||(e=t.Node.create('<div style="position: absolute; bottom: 40px; left: 0; right: 0;"><div class="flickr-dots"></div></div>'),this._set("throbberNode",e)),e}}}})},"@VERSION@",{requires:["flickr-view","hermes-template-infinite-scroll-load-more","hermes-template-license-detail","photo-list-layout","photo-list-photo-view","overflow-helper","storage-helper","attribute-helpers","url-helper","paged-collection","fluid-droparound-view"],optionalRequires:["global-events"],langBundles:["common"]});YUI.add("hermes-template-photo-list-demo-subview",function(e,t){var a=e.Template.Handlebars.revive({compiler:[7,">= 4.0.0"],main:function(e,t,a,r,l){return e.escapeExpression((a.outlet||t&&t.outlet||a.helperMissing).call(null!=t?t:{},null!=t?t["photo-list-view"]:t,{name:"outlet",hash:{},data:l}))},useData:!0}),r={};e.Array.each([],function(t){var a=e.Template.get("hermes/"+t);a&&(r[t]=a)}),e.Template.register("hermes/photo-list-demo-subview",function(t,l){return l=l||{},l.partials=l.partials?e.merge(r,l.partials):r,a(t,l)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("photo-selector-photolist-view",function(e){e.namespace("Views")[this.name]=e.Base.create(this.name,e.FlickrView,[],{initializer:function(i){return i.photolistViewClasses&&(i.additionalViewClasses=i.photolistViewClasses),i.photoListConfig=e.merge(i.primaryPhotoListConfig),i.publicOnlyPhotos=i.publicOnlyPhotos,""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this},subviewConfig:{"photo-list-view":{requiredToShowOnClient:!0,requiredToShowOnServer:!0}},loadState:function(){return e.Promise.resolve()},buildContainer:function(){return this.setContainerWithTemplate("photo-list-demo-subview"),this},activate:function(){return this}})},"@VERSION@",{requires:["flickr-view","photo-list-view","hermes-template-photo-list-demo-subview"]});YUI.add("hermes-template-search-photos-single-row",function(l,e){var a=l.Template.Handlebars.revive({1:function(l,e,a,n,t){var s,r,i=null!=e?e:{};return'\t<h5 class="search-results-header">'+(null!=(s=a.unless.call(i,null!=e?e.loading:e,{name:"unless",hash:{},fn:l.program(2,t,0),inverse:l.noop,data:t}))?s:"")+l.escapeExpression("function"==typeof(r=null!=(r=a.title||(null!=e?e.title:e))?r:a.helperMissing)?r.call(i,{name:"title",hash:{},data:t}):r)+" "+(null!=(s=a.if.call(i,null!=e?e.loading:e,{name:"if",hash:{},fn:l.program(6,t,0),inverse:l.noop,data:t}))?s:"")+"</h5>\n"+(null!=(s=a.if.call(i,null!=e?e.loading:e,{name:"if",hash:{},fn:l.program(8,t,0),inverse:l.program(10,t,0),data:t}))?s:"")},2:function(l,e,a,n,t){var s;return null!=(s=a.unless.call(null!=e?e:{},null!=e?e.singleResult:e,{name:"unless",hash:{},fn:l.program(3,t,0),inverse:l.noop,data:t}))?s:""},3:function(l,e,a,n,t){var s,r,i=null!=e?e:{},u=a.helperMissing,o=l.escapeExpression;return'<a href="'+o("function"==typeof(r=null!=(r=a.viewAll||(null!=e?e.viewAll:e))?r:u)?r.call(i,{name:"viewAll",hash:{},data:t}):r)+'" class="view-more-link"'+(null!=(s=a.if.call(i,null!=e?e.viewAllDataTrack:e,{name:"if",hash:{},fn:l.program(4,t,0),inverse:l.noop,data:t}))?s:"")+">"+o((a.intlHTMLMessage||e&&e.intlHTMLMessage||u).call(i,{name:"intlHTMLMessage",hash:{count:null!=e?e.total:e,intlName:"search.VIEW_ALL_COUNT"},data:t}))+"</a>"},4:function(l,e,a,n,t){var s;return' data-track="'+l.escapeExpression("function"==typeof(s=null!=(s=a.viewAllDataTrack||(null!=e?e.viewAllDataTrack:e))?s:a.helperMissing)?s.call(null!=e?e:{},{name:"viewAllDataTrack",hash:{},data:t}):s)+'"'},6:function(l,e,a,n,t){return'<div class="flickr-dots inline"></div>'},8:function(l,e,a,n,t){var s;return'\t\t<div style="height: '+l.escapeExpression("function"==typeof(s=null!=(s=a.placeholderHeight||(null!=e?e.placeholderHeight:e))?s:a.helperMissing)?s.call(null!=e?e:{},{name:"placeholderHeight",hash:{},data:t}):s)+'px;"></div>\n'},10:function(l,e,a,n,t){return"\t\t"+l.escapeExpression((a.outlet||e&&e.outlet||a.helperMissing).call(null!=e?e:{},null!=e?e["photo-list-view"]:e,{name:"outlet",hash:{},data:t}))+"\n"},compiler:[7,">= 4.0.0"],main:function(l,e,a,n,t){var s;return null!=(s=a.unless.call(null!=e?e:{},null!=e?e.emptySearch:e,{name:"unless",hash:{},fn:l.program(1,t,0),inverse:l.noop,data:t}))?s:""},useData:!0}),n={};l.Array.each([],function(e){var a=l.Template.get("hermes/"+e);a&&(n[e]=a)}),l.Template.register("hermes/search-photos-single-row",function(e,t){return t=t||{},t.partials=t.partials?l.merge(n,t.partials):n,a(e,t)})},"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("photo-lite-models",function(e){function t(e){t.superclass.constructor.call(this,e)}e.Models[this.name]=t,e.extend(t,e.FlickrModelRegistry,{name:this.name,remote:{update:e.PhotoModelHelper.updateEngagement},toggleFave:e.PhotoModelHelper.toggleFave,addAsFave:e.PhotoModelHelper.addAsFave,getLargestSize:e.PhotoModelHelper.getLargestSize,getSizeToFit:e.PhotoModelHelper.getSizeToFit,getSizeIfExact:e.PhotoModelHelper.getSizeIfExact,isSizeSquare:e.PhotoModelHelper.isSizeSquare,isPhotoSquare:e.PhotoModelHelper.isPhotoSquare,attributes:{owner:{readOnly:!0,isModel:!0,getter:function(e,t){var r=this;return{id:r.getValue(t,"ownerNsid"),getValue:function(e){return"id"===e?r.getValue(t,"ownerNsid"):"nsid"===e?r.getValue(t,"ownerNsid"):"url"===e?r.getValue(t,"ownerUrl"):r.getValue(t,e)},toJSON:function(){return{id:r.getValue(t,"ownerNsid"),url:r.getValue(t,"ownerUrl"),pathAlias:r.getValue(t,"pathAlias"),username:r.getValue(t,"username"),realname:r.getValue(t,"realname"),displayname:r.getValue(t,"displayname"),nsid:r.getValue(t,"ownerNsid"),ownerUrl:r.getValue(t,"ownerUrl"),isMe:r.getValue(t,"isMe")}},exists:function(e){return!1}}}},pathAlias:e.PersonModelHelper.attributes.pathAlias,username:e.PersonModelHelper.attributes.username,realname:e.PersonModelHelper.attributes.realname,displayname:e.PersonModelHelper.attributes.displayname,nsid:e.PersonModelHelper.attributes.nsid,ownerUrl:e.PersonModelHelper.attributes.url,isMe:e.PersonModelHelper.attributes.isMe,engagement:{readOnly:!0,isModel:!0,getter:function(e,t){var r=this;return{getValue:function(e){return r.getValue(t,e)},toJSON:function(){return{ownerNsid:r.getValue(t,"ownerNsid"),isFaved:r.getValue(t,"isFaved"),faveCount:r.getValue(t,"faveCount"),commentCount:r.getValue(t,"commentCount"),canFave:r.getValue(t,"canFave")}},exists:function(e){return!1}}}},ownerNsid:e.PhotoModelHelper.attributes.ownerNsid,isFaved:e.PhotoModelHelper.attributes.isFaved,faveCount:e.PhotoModelHelper.attributes.faveCount,commentCount:e.PhotoModelHelper.attributes.commentCount,canFave:e.PhotoModelHelper.attributes.canFave,title:e.PhotoModelHelper.attributes.title,description:e.PhotoModelHelper.attributes.description,mediaType:e.PhotoModelHelper.attributes.mediaType,license:e.PhotoModelHelper.attributes.license,isVideo:e.PhotoModelHelper.attributes.isVideo,isOwner:e.PhotoModelHelper.attributes.isOwner,sizes:e.PhotoModelHelper.attributes.sizes,descendingSizes:e.PhotoModelHelper.attributes.descendingSizes,ascendingSizes:e.PhotoModelHelper.attributes.ascendingSizes,aspectRatio:e.PhotoModelHelper.attributes.aspectRatio,needsInterstitial:e.PhotoModelHelper.attributes.needsInterstitial,canComment:e.PhotoModelHelper.attributes.canComment,url:e.PhotoModelHelper.attributes.url,rotation:e.PhotoModelHelper.attributes.rotation,similaritySearchURL:e.PhotoModelHelper.attributes.similaritySearchURL,basicSimilaritySearchURL:e.PhotoModelHelper.attributes.basicSimilaritySearchURL,oWidth:{validator:function(t){return e.AttributeHelpers.validateInteger(t)},setter:function(t){return e.AttributeHelpers.coerceInteger(t)},defaultValue:0},oHeight:{validator:function(t){return e.AttributeHelpers.validateInteger(t)},setter:function(t){return e.AttributeHelpers.coerceInteger(t)},defaultValue:0},isPublic:{validator:function(t){return e.AttributeHelpers.validateBoolean(t)},setter:function(t){return e.AttributeHelpers.coerceBoolean(t)},defaultValue:!1},isVisibleByFriends:{validator:function(t){return e.AttributeHelpers.validateBoolean(t)},setter:function(t){return e.AttributeHelpers.coerceBoolean(t)},defaultValue:!1},isVisibleByFamily:{validator:function(t){return e.AttributeHelpers.validateBoolean(t)},setter:function(t){return e.AttributeHelpers.coerceBoolean(t)},defaultValue:!1}}})},"@VERSION@",{requires:["flickr-model-registry","photo-model-helper","person-model-helper","flickr-favorites-add-updater","flickr-favorites-remove-updater","photo-models","photo-engagement-models","person-models"]});YUI.add("search-photos-lite-models",function(e){function t(e){t.superclass.constructor.call(this,e)}e.Models[this.name]=t,e.extend(t,e.FlickrModelRegistry,{name:this.name,remote:{read:function(t){return t.getPhotoLiteModels=!0,e.ListFetchers["flickr-photos-search"].run(t,this.appContext)}},attributes:{photos:{isCollection:!0,pageFetch:{fetchParams:{getPhotoLiteModels:!0},listFetcher:e.ListFetchers["flickr-photos-search"],listItemIdField:"photoId"}},totalItems:{setter:function(t){return(t=e.AttributeHelpers.coerceInteger(t))<0&&(t=0),t},defaultValue:0},apiParams:{writeOnce:"initOnly"},emptyQuery:{defaultValue:!1}}})},"@VERSION@",{requires:["flickr-model-registry","flickr-photos-search-fetcher","attribute-helpers"]});YUI.add("flickr-photos-search-fetcher",function(e,o){"use strict";var t=require("superagent"),r=require("hermes-core/flog")(o);e.namespace("ListFetchers")["flickr-photos-search"]={run:function(s,a){var p,i=this,l=s.emptyQuery?{}:this._processParams(e.merge({lang:a.lang||e.config.lang},s),a);if(l||(s.emptyQuery=!0),s.useV2API){var n=s.apiParams.tags||s.apiParams.text,h={orderBy:"interestingness",query:n,pageNumber:s.page-1>=0?s.page-1:0,pageSize:s.perPage,format:"json",nojsoncallback:1};s.minDateTaken&&s.maxDateTaken&&(s.apiParams.tags||s.apiParams.text)&&(h.query=e.SearchHelper.normalizeTag(n),h.context="tag:"+e.SearchHelper.normalizeTag(n)+" dateUploaded:["+s.minDateTaken+" TO "+s.maxDateTaken+"]"),p=[t.get("https://api.flickr.com/v2/media/search").use(require("hermes-core/req-id")).query(h).catch(function(e){return r.warn("API V2 Search returned a non valid response",{err:e}),{body:[],headers:{"x-total-count":0}}})]}else p=[s.emptyQuery?e.Promise.resolve({photos:{photo:[]}}):a.callAPI("flickr.photos.search",l)];return p=s.getPhotoLiteModels?p.concat([a.getModelRegistry("search-photos-lite-models"),a.getModelRegistry("photo-lite-models")]):p.concat([a.getModelRegistry("search-photos-models"),a.getModelRegistry("photo-models"),a.getModelRegistry("person-models"),a.getModelRegistry("photo-engagement-models"),a.getModelRegistry("photo-stats-models"),a.getModelRegistry("photo-geo-models")]),e.Promise.all(p).then(function(e){return i._processResponse(e,s)},e.FetcherErrorLogger(o))},_processParams:function(o,t){var r,s=e.merge(e.SearchHelper.UNIFIED_DEFAULT_PARAMS,{extras:e.APIHelper.request[o.getPhotoLiteModels?"getRebootPhotoLiteExtras":"getRebootPhotoExtras"](),per_page:o.perPage||50,page:o.page||"1",lang:o.lang});return o.fetchGeo&&(s.extras+=",geo"),o.additionalExtras&&(s.extras+=","+o.additionalExtras.join(",")),r=e.merge(s,o.apiParams||{}),o.privacyFilter&&(r.privacy_filter=o.privacyFilter),YUI.Env.isServer&&e.SearchHelper.unescapeParameters(r),e.SearchHelper.isParameterlessSearch(r)?null:r},_processResponse:function(o,t){var r,s,a,p,i,l,n=o[0],h=o[1],d=o[2],g={id:t.id||e.SearchUrl.EMPTY_SEARCH_ID,apiParams:{},emptyQuery:!!t.emptyQuery,photos:[]};if(t.id&&t.id!==e.SearchUrl.EMPTY_SEARCH_ID&&(g.apiParams=e.QueryString.parse(t.id)),!t.id)throw new ReferenceError("No `id` provided by request.");if(!(t.useV2API||n.photos&&n.photos.photo)){var c=new Error("No `photos.photo` property returned by search API v1.");throw c.fatal=!0,c}var u=t.useV2API?n.body:n.photos.photo;return t.getPhotoLiteModels?a=u.map(function(o){return i=e.APIHelper.response.parsePhotoLite(o),d.addOrUpdate(i)}):(a=e.APIHelper.response.parsePhotos({photos:n.photos.photo,photoModelRegistry:d,personModelRegistry:o[3],photoEngagementModelRegistry:o[4],photoStatsModelRegistry:o[5]}),t.fetchGeo&&(r=o[6],n.photos.photo.forEach(function(e){p=void 0!==e.latitude?{id:e.id,hasGeo:!0,latitude:e.latitude,longitude:e.longitude}:{id:e.id,hasGeo:!1},r.addOrUpdate(p)}))),g.photos={perPage:t.useV2API?t.perPage:n.photos.perpage,page:t.useV2API?t.page:n.photos.page,pageContent:a,totalItems:t.useV2API?n.headers["x-total-count"]:parseInt(n.photos.total,10),totalPages:t.useV2API?parseInt(n.headers["x-total-count"]/t.perPage,10):n.photos.pages/t.perPage},!t.useV2API&&n.photos.maxAllowedResults&&(g.photos.totalItems=Math.min(n.photos.maxAllowedResults,parseInt(n.photos.total,10))),!t.useV2API&&n.photos.maxAllowedPages&&(g.photos.totalPages=Math.min(n.photos.maxAllowedPages,n.photos.pages)),g.totalItems=t.useV2API?n.headers["x-total-count"]:parseInt(n.photos.total,10),h.exists(g.id)?(s=h.getValue(g.id,"photos").getList(),l=s.filter(function(e){return!!e}).reduce(function(e,o){return e[o.id]=!0,e},{}),g.photos.pageContent=g.photos.pageContent.filter(function(e){return!l[e.id]}),1===g.photos.page&&(g.photos.forceAppend=!0),h.addOrUpdate(g)):h.add(g),a}}},"@VERSION@",{requires:["flickr-promise","search-helper","search-url","api-helper","querystring-parse-simple"],optional:["search-photos-models","search-photos-lite-models","photo-models","photo-lite-models","person-models","photo-engagement-models","photo-stats-models","photo-geo-models"],optionalRequires:["superagent"]});